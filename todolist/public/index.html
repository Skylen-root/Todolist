<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <!-- <script src="script.js" defer></script> -->

</head>
<body>
    <div class="wrapper">
        <!-- <div class="control-panel">
            <input class="addItem" type="text"><input type="button" id="add" value="add">

        </div> -->




        <!-- <div class="todolist">
            <form name="userForm">
                <input type="hidden" name="id" value="0" />
                <div class="form-group">
                    <label for="name">Имя:</label>
                    <input class="form-control" name="name" />
                </div>
                <div class="form-group">
                    <label for="age">Возраст:</label>
                    <input class="form-control" name="age" />
                </div>
                <div class="panel-body">
                    <button type="submit" class="btn btn-sm btn-primary">Сохранить</button>
                    <a id="reset" class="btn btn-sm btn-primary">Сбросить</a>
                </div>
            </form> -->


            <form name="todolist">
                <label for="title">Title</label>
                <input name="title">
                <label for="content">Content</label>
                <input name="content">
                <button type="submit">Create</button>
                <div>
                    <label for="deleteTask">Delete User by id</label>
                    <input name="deleteTask">
                    <button id="deletetask" type="button">Delete</button><span id = "sp"></span>
                </div>
            </form>


            <button type="button" id="get-tasks-list">Get Tasks List</button>
            <div id="tasks-list">

            </div>

            

        </div>

        <div class="row">
            <div id="out">
            
    
                
    
            </div>
            <div id="out2">
                
                
    
            </div>
        </div>

        
    </div>
    
    <script>

        let taskList;




        async function CreateTask(title, content) {

            const response = await fetch("http://localhost:3000/api/newtask", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    title: title,
                    content: content
                })
            });
            if (response.ok === true) {
                result = await response.json();
                console.log(result);
            }
            // if (response.ok === true) {
            //     const user = await response.json();
            //     reset();
            //     document.querySelector("tbody").append(row(user));
            // }
            GetTaskList();
        }

        async function DeleteTask(id) {

            const response = await fetch("http://localhost:3000/api/task", {
                method: "DELETE",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: id
                })
            });
            if(response.ok === true) {
                result = await response.json();
                if(result === 0){
                    document.querySelector("#sp").innerHTML = "User not found";
                }
                else {
                    document.querySelector("#sp").innerHTML = "Done"
                }
            }
            
            GetTaskList();
        }


        async function GetTaskList(){
            const response = await fetch("http://localhost:3000/api/tasks", {
                method: "GET",
                headers: { "Accept": "application/json" }
            })
            if(response.ok === true) {
                result = await response.json();
                
                ShowList(result);
                return result;
                //document.querySelector("#tasks-list").innerHTML = JSON.stringify(result);
            }
            else {
                return "Something wrong";
            }




        }


        document.forms["todolist"].addEventListener("submit", e => {
            e.preventDefault();
            const form = document.forms["todolist"];
            const title = form.elements["title"].value;
            const content = form.elements["content"].value;
            CreateTask(title,content);
        });


        document.querySelector("#deletetask").addEventListener("click", e => {
            const form = document.forms["todolist"];
            const id = form.elements["deleteTask"].value;
            DeleteTask(id);
        })



        document.querySelector("#get-tasks-list").addEventListener("click", e => {
            taskList =  GetTaskList();
            let a;
            taskList.then(
                function(result){
                    a = JSON.stringify(result);
                    //document.querySelector("#tasks-list").innerHTML = a;
                    //console.log(result[55])
                    ShowList(result);
                    //document.querySelector("#tasks-list").innerHTML = JSON.stringify(result[3].id);
                },

                function(error){console.log(error);}
            )
            console.log(JSON.stringify(taskList));
            //taskList.then()
            
        })



        // document.querySelectorAll(".button-delete-task").addEventListener("click", e => {
        //     console.log(this);
        // })

        function DeleteTaskButton() {
            let buttonsDeleteTask = document.querySelectorAll(".button-delete-task");

            buttonsDeleteTask.forEach(function (elem) {
                elem.addEventListener("click", function(e){
                    console.log(this.parentElement.id);
                    DeleteTask(this.parentNode.id.slice(5))
                });
            })
        }
        

        function ShowList(list) {

            let out;
//             for(let i in list) {
//                 out += `<div>
//     <p>№ ${list[i].id}. Title: ${list[i].title}. Content: ${list[i].content}</p>
// </div>`
//             }

            for (let i = list.length - 1; i >= 0; i--) {
                out += `<div  id="task-${list[i].id}">№ ${list[i].id}. Title: ${list[i].title}. Content: ${list[i].content} <button class="button-delete-task">Delete task</button>
</div>`
            }

            document.querySelector("#tasks-list").innerHTML = out;
            DeleteTaskButton();
        }



        GetTaskList();
</script>

</body>
</html>